#!/bin/bash
# box.sh <номер_ящика> <время> [current_fill]

# ─────────────── Функции ───────────────
to_hms () {
    local t=$1
    printf "%02d:%02d:%02d" $(( (t/3600) % 24 )) $(((t%3600)/60)) $((t%60))
}

ask() {
    echo
    echo "        __________"
    echo "          box N: $box_num"
    echo "           C120: $c120"
    echo "текущая брояжка: $current_fill"
    echo "вместимость box: $max_fill"
    echo "изделий за удар: $per_stroke"
    echo "    время цикла: $cycle_time "
    echo "    время ящика: $tsikl"
}

# ─────────────── Цвета ───────────────
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
NC=$(tput sgr0)

# ─────────────── Ввод данных ───────────────
box_num=$1
time_input=$2
current_fill=$3

clear
ask

if [ -z "$box_num" ]; then
    echo "box num?"
    read box_num
fi

if [ -z "$c120" ]; then
    echo "c120 ?"
    read c120
fi

if [ -z "$current_fill" ]; then
    echo "текущая брояжка (сколько уже в ящике?)"
    read current_fill
    if [ "$current_fill" ]; then
        time_input=$(date +%H:%M:%S)
    fi
fi

if [[ -z "$current_fill" && -z $time_input ]]; then
    echo "когда закончился ящик $box_num?"
    read time_input
    time_input="${time_input}:00"
fi

if [ -z "$max_fill" ]; then
    echo "вместимость ящика?"
    read max_fill
fi

if [ -z "$per_stroke" ]; then
    echo "сколько изделий за удар?"
    read per_stroke
fi

if [ -z "$cycle_box_shot" ]; then
    echo "время цикла удара (секунд, можно с дробной частью)"
    read cycle_box_shot
fi

# ─────────────── Расчёты ───────────────
ydarov=$(echo "scale=6; $max_fill / $per_stroke" | bc)
tsikl=$(echo "scale=6; $ydarov * $cycle_box_shot" | bc)

# время в секундах
IFS=: read h m s <<< "$time_input"
end_sec=$(echo "$h*3600 + $m*60 + $s" | bc)

# если указан current_fill → пересчёт
if [ -n "$current_fill" ]; then
    remain=$(echo "($max_fill - $current_fill) / $per_stroke" | bc)
    remain_time=$(echo "$remain * $cycle_box_shot" | bc)
    end_sec=$(echo "$end_sec + $remain_time" | bc)
    c120_end=$(echo "$c120 + $remain" | bc)
else
    c120_end=$(echo "$c120 + ($max_fill / $per_stroke)" | bc)
fi

# ─────────────── Смены ───────────────
shift1_start=$(echo "6*3600+30*60" | bc)
shift1_end=$(echo "18*3600+30*60" | bc)
shift2_end=$(echo "24*3600+6*3600+30*60" | bc)

first_end_sec=$(echo "$end_sec - ($box_num - 1) * $tsikl" | bc)

if (( $(echo "$end_sec >= $shift1_start && $end_sec <= $shift1_end" | bc) )); then
    current_shift_end=$shift1_end
    cmena=1
else
    if (( $(echo "$end_sec < $shift1_start" | bc) )); then
        first_end_sec=$(echo "86400 + $first_end_sec" | bc)
        end_sec=$(echo "86400 + $end_sec" | bc)
    fi
    current_shift_end=$shift2_end
    cmena=2
fi

# ─────────────── Вывод ───────────────
echo "Смена: $cmena"
i=1
current_end=$first_end_sec
current_c120=$(echo "$c120_end - ($box_num - 1) * ($max_fill / $per_stroke)" | bc)

while (( $(echo "$current_end <= $current_shift_end" | bc) )); do
    sec_int=$(echo "$current_end/1" | bc)
    echo "Box $(printf "%2d" $i) - $(to_hms $sec_int) | C120: $current_c120"
    i=$((i+1))
    current_end=$(echo "$current_end + $tsikl" | bc)
    current_c120=$(echo "$current_c120 + ($max_fill / $per_stroke)" | bc)
done

first_box_next_end=$current_end
sec_int=$(echo "$first_box_next_end/1" | bc)
echo "${RED}Box  1 - $(to_hms $sec_int) | C120: $current_c120${NC}"
